<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">

	<id>emanuele:full_reply_in_topic</id>
	<version>0.1.1</version>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="before"><![CDATA[
		loadTemplate('Display');]]></search>
			<add><![CDATA[

	$context['is_quick_reply_full'] = true;
	require_once($sourcedir.'/Post.php');
	Post();
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Post.php">
		<operation>
			<search position="replace"><![CDATA[
			$_REQUEST['preview'] = true;
			return Post();
]]></search>
			<add><![CDATA[
			$options['display_quick_reply'] = 2;
			$_REQUEST['start'] = 'msg'.$topic_info['id_last_msg'];
			$_REQUEST['preview'] = true;
			if(isset($_POST['from_display'])){
				require_once($sourcedir . '/Display.php');
				return Display();
			}
			return Post();
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
		return Post();
	}]]></search>
			<add><![CDATA[
		if(isset($_POST['from_display'])){
			require_once($sourcedir . '/Display.php');
			return Display();
		}
		return Post();
	}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	// Finally, load the template.
	if (WIRELESS && WIRELESS_PROTOCOL != 'wap')
		$context['sub_template'] = WIRELESS_PROTOCOL . '_post';
	elseif (!isset($_REQUEST['xml']))
		loadTemplate('Post');
]]></search>
			<add><![CDATA[
	if(!isset($context['is_quick_reply_full'])){
		// Finally, load the template.
		if (WIRELESS && WIRELESS_PROTOCOL != 'wap')
			$context['sub_template'] = WIRELESS_PROTOCOL . '_post';
		elseif (!isset($_REQUEST['xml']))
			loadTemplate('Post');
	}
]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
		if (!empty($context['new_replies']))
			$context['new_replies']--;
	}]]></search>
			<add><![CDATA[
	if(isset($_GET['is_quick_reply_full']) && empty($options['view_newest_first']))
		$context['previous_posts'] = array_reverse($context['previous_posts']);
]]></add>
		</operation>
	</file>

	<file name="$themedir/Display.template.php">
		<operation>
			<search position="after"><![CDATA[
		// Show the message anchor and a "new" anchor if this message is new.
]]></search>
			<add><![CDATA[
	if(!empty($options['view_newest_first']))
		echo '
				<span id="new_replies"></span>';
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
	echo '
				</form>
]]></search>
			<add><![CDATA[
	if(empty($options['view_newest_first']))
		echo '
				<span id="new_replies"></span>';
]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[
	// Show the anchor for the top and for the first message. If the first message is new, say so.
]]></search>
			<add><![CDATA[
	// Start the javascript... and boy is there a lot.
	echo '
		<script type="text/javascript"><!-- // --><![CD', 'ATA[';

	// When using Go Back due to fatal_error, allow the form to be re-submitted with changes.
	if ($context['browser']['is_firefox'])
		echo '
			function reActivate()
			{
				document.forms.postmodify.message.readOnly = false;
			}
			window.addEventListener("pageshow", reActivate, false);';

	// Start with message icons - and any missing from this theme.
	echo '
			var icon_urls = {';
	foreach ($context['icons'] as $icon)
		echo '
				\'', $icon['value'], '\': \'', $icon['url'], '\'', $icon['is_last'] ? '' : ',';
	echo '
			};';

	// The actual message icon selector.
	echo '
			function showimage()
			{
				document.images.icons.src = icon_urls[document.forms.postmodify.icon.options[document.forms.postmodify.icon.selectedIndex].value];
			}';

	// If this is a poll - use some javascript to ensure the user doesn't create a poll with illegal option combinations.
	if ($context['make_poll'])
		echo '
			function pollOptions()
			{
				var expire_time = document.getElementById(\'poll_expire\');

				if (isEmptyText(expire_time) || expire_time.value == 0)
				{
					document.forms.postmodify.poll_hide[2].disabled = true;
					if (document.forms.postmodify.poll_hide[2].checked)
						document.forms.postmodify.poll_hide[1].checked = true;
				}
				else
					document.forms.postmodify.poll_hide[2].disabled = false;
			}

			var pollOptionNum = 0, pollTabIndex;
			function addPollOption()
			{
				if (pollOptionNum == 0)
				{
					for (var i = 0, n = document.forms.postmodify.elements.length; i < n; i++)
						if (document.forms.postmodify.elements[i].id.substr(0, 8) == \'options-\')
						{
							pollOptionNum++;
							pollTabIndex = document.forms.postmodify.elements[i].tabIndex;
						}
				}
				pollOptionNum++

				setOuterHTML(document.getElementById(\'pollMoreOptions\'), ', JavaScriptEscape('<li><label for="options-'), ' + pollOptionNum + ', JavaScriptEscape('">' . $txt['option'] . ' '), ' + pollOptionNum + ', JavaScriptEscape('</label>: <input type="text" name="options['), ' + pollOptionNum + ', JavaScriptEscape(']" id="options-'), ' + pollOptionNum + ', JavaScriptEscape('" value="" size="80" maxlength="255" tabindex="'), ' + pollTabIndex + ', JavaScriptEscape('" class="input_text" /></li><li id="pollMoreOptions"></li>'), ');
			}';

	// If we are making a calendar event we want to ensure we show the current days in a month etc... this is done here.
	if ($context['make_event'])
		echo '
			var monthLength = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

			function generateDays()
			{
				var dayElement = document.getElementById(\'day\'), yearElement = document.getElementById(\'year\'), monthElement = document.getElementById(\'month\');
				var days, selected = dayElement.selectedIndex;

				monthLength[1] = yearElement.options[yearElement.selectedIndex].value % 4 == 0 ? 29 : 28;
				days = monthLength[monthElement.value - 1];

				while (dayElement.options.length)
					dayElement.options[0] = null;

				for (i = 1; i <= days; i++)
					dayElement.options[dayElement.length] = new Option(i, i);

				if (selected < days)
					dayElement.selectedIndex = selected;
			}';

	// End of the javascript, start the form and display the link tree.
	echo '
		// ]', ']></script>';
	if ($context['can_reply'] && !empty($options['display_quick_reply']) && !empty($options['view_newest_first']))
	{
		output_Editor();
	}
	else
		echo '
		<br class="clear" />';
]]></add>
		</operation>


		<operation>
			<search position="replace"><![CDATA[
	if ($context['can_reply'] && !empty($options['display_quick_reply']))
	{]]></search>
			<add><![CDATA[
	if ($context['can_reply'] && !empty($options['display_quick_reply']) && empty($options['view_newest_first']))
	{
		output_Editor();
	}
	else
		echo '
		<br class="clear" />';
/*]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
							sItemBackgroundHover: "#e0e0f0"
						});
					}';]]></search>
			<add><![CDATA[*/
	echo '
				<script type="text/javascript"><!-- // --><![CD', 'ATA[';]]></add>
		</operation>
	</file>
</modification>